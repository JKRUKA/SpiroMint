name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # 打印仓库结构 + 自动找到含有 "build" 脚本的 package.json 所在目录
      - name: Detect frontend dir
        id: detect
        run: |
          echo "PWD: $(pwd)"
          echo "== Top-level =="
          ls -la
          echo "== package.json candidates (max depth 4) =="
          find . -maxdepth 4 -name package.json -not -path "*/node_modules/*" -print

          FRONTEND_DIR=""
          for f in $(find . -maxdepth 4 -name package.json -not -path "*/node_modules/*"); do
            if grep -q '"build"' "$f"; then
              FRONTEND_DIR="$(dirname "$f")"
              break
            fi
          done

          if [ -z "$FRONTEND_DIR" ]; then
            echo "::error::Could not find a package.json with a build script. Please check your repo."
            exit 1
          fi

          echo "Detected frontend dir: $FRONTEND_DIR"
          echo "FRONTEND_DIR=$FRONTEND_DIR" >> $
